/*! mg-api-js - v1.0.0
 *  Release on: 2017-05-09
 *  Copyright (c) 2017 Geotab Inc
 *  Licensed MIT */

!function(a,b){"function"==typeof define&&define.amd?define([],function(){return a.GeotabApi=b()}):"object"==typeof module&&module.exports?module.exports=b():a.GeotabApi=b()}(this,function(){return function(a,b,c){"use strict";var d,e,f,g=[],h={rememberMe:!0,debug:!1,jsonp:!1,timeout:0},i=function(){if(h.debug){var a=[new Date];a.push.apply(a,arguments),console.log.apply(console,a)}},j=function(a,b){var c;a&&a.name&&a.message?c=a.name+": "+a.message:(a.target||a instanceof XMLHttpRequest&&0===a.status)&&(c="Network Error: Couldn't connect to the server. Please check your network connection and try again."),h.debug&&console.error(c,a),b&&b(c||"Error",a)},k=function(a){return"https://"+e.replace(/\S*:\/\//,"").replace(/\/$/,"")+"/apiv1"+(a?"/"+a:"")},l=function(a){var b=document.getElementById(a);if(b){b.parentNode.removeChild(b);for(var c in b)b.hasOwnProperty(c)&&delete b[c]}delete window.geotabJSONP[a]},m=function(a,b,c,d){var e,f="json"+(100*Math.random()).toString().replace(/\./g,""),g=function(){b=b||{};var a=[];for(var c in b)b.hasOwnProperty(c)&&a.push.apply(a,["&",encodeURIComponent(c),"=",encodeURIComponent(JSON.stringify(b[c]))]);return a.join("")};return window.geotabJSONP[f]=function(b){e&&(clearTimeout(e),e=null);try{if(b&&b.error)i(a,"ERROR",b.error),j(b.error,d);else{var g=b.result;i(a,"SUCCESS",{result:g}),c&&c(g)}}finally{l(f)}},document.getElementsByTagName("body")[0].appendChild(function(){var b=document.createElement("script");return b.type="text/javascript",b.id=f,b.async="async",b.src=k(a)+"?JSONP=geotabJSONP."+f+g(),b.onerror=function(b){try{i("CallJSONP",a,"ERROR",b),j(b,d)}finally{l(f)}},b}()),e&&clearTimeout(e),h.timeout&&"Authenticate"!==a&&(e=setTimeout(function(){window.geotabJSONP.hasOwnProperty(f)&&(window.geotabJSONP[f]({error:{name:"JSONPTimeout",message:"Could not complete the JSONP request in a timely manner ("+h.timeout+"s)",target:document.getElementById(f)}}),window.geotabJSONP[f]=function(){l(f)})},1e3*h.timeout)),{abort:function(){l(f),d&&d("Cancelled",{})}}},n=function(a,b,c,d){var e=new XMLHttpRequest;e.open("POST",k(),!0),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e.addEventListener("abort",function(a){d&&d("Cancelled",a)}),e.onreadystatechange=function(){if(4===e.readyState)if(200===e.status){var b,f,g;try{b=JSON.parse(e.responseText),b&&b.error?(f=b.error,i(a,"ERROR",f),j(f,d)):(g=b.result,i(a,"SUCCESS",{result:g}),c(g))}catch(a){j(a,d)}}else i(a,"ERROR",e),j(e,d)};var f;try{f=JSON.stringify({method:a||"",params:b})}catch(a){return void j(a,d)}return h.timeout&&(e.timeout=1e3*h.timeout),e.send("JSON-RPC="+encodeURIComponent(f)),{abort:function(){e.abort()}}},o=function(a,b,c,d){return h.jsonp?m(a,b,c,d):n(a,b,c,d)},p=function(a,b,c,g,i,j){return e=a,o("Authenticate",{database:b,userName:c,password:g},function(a){a.path&&"ThisServer"!==a.path&&(e="https://"+a.path+"/"),d=a.credentials,h.rememberMe&&f.set(d,e),i&&i()},j)},q=function(b){a(function(a,c,d,e,f){return p(a,c,d,e,function(){b&&b(),g.forEach(function(a){r.apply(this,a)}),g=[]},f)})},r=function(a,b,c,i){var j=function(){g.push([a,b,c,i]);var j=f.get();j&&h.rememberMe?(d=j.credentials,e=j.server,g.forEach(function(a){r.apply(this,a)}),g=[]):q()};return d?(b.credentials=d,o(a,b,c,function(b,c){var d=c.errors;d&&d[0]&&"InvalidUserException"===d[0].name&&"Authenticate"!==a?(f.clear(),j()):i&&i(b,c)})):(j(),{abort:function(){}})},s=function(a,b,c){var d=a.map(function(a){var b=a[1];return{method:a[0],params:b}});return r("ExecuteMultiCall",{calls:d},b,c)},t=function(a,b){var c=f.get();if(!b&&c&&h.rememberMe)return void(a&&a(c.credentials,c.server));q(function(){a&&a(d,e)})},u=function(){d=null,f.clear(),q()};if(b)for(var v in b)b.hasOwnProperty(v)&&(h[v]=b[v]);window.geotabJSONP={};var w={CREDENTIALS_KEY:"geotabAPI_credentials",SERVER_KEY:"geotabAPI_server",get:function(){var a=localStorage.getItem(this.CREDENTIALS_KEY),b=localStorage.getItem(this.SERVER_KEY),c=!1;if(a&&b)try{c={credentials:JSON.parse(a),server:b}}catch(a){return!1}return c},set:function(a,b){localStorage.setItem(this.CREDENTIALS_KEY,JSON.stringify(a)),localStorage.setItem(this.SERVER_KEY,b)},clear:function(){localStorage.removeItem(this.CREDENTIALS_KEY),localStorage.removeItem(this.SERVER_KEY)}};return f=c||w,{call:r,multiCall:s,forget:u,getSession:t}}});
